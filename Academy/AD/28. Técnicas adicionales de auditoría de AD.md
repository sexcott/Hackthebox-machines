-------
- Tags: #AD-Exploter #pingcastle #group3r #ADRecon
---------
## Crear una instantánea de AD con Active Directory Explorer

[AD Explorer](https://docs.microsoft.com/en-us/sysinternals/downloads/adexplorer) es parte de Sysinternal Suite y se describe como:

"Un visor y editor avanzado de Active Directory (AD). Puede utilizar AD Explorer para navegar fácilmente por una base de datos de AD, definir ubicaciones favoritas, ver propiedades y atributos de objetos sin abrir cuadros de diálogo, editar permisos, ver el esquema de un objeto y ejecutar aplicaciones sofisticadas. búsquedas que puedes guardar y volver a ejecutar."

AD Explorer también se puede utilizar para guardar instantáneas de una base de datos de AD para verlas y compararlas sin conexión. Podemos tomar una instantánea de AD en un momento determinado y explorarla más tarde, durante la fase de generación de informes, como lo haría con cualquier otra base de datos. También se puede utilizar para realizar una comparación antes y después de AD para descubrir cambios en objetos, atributos y permisos de seguridad.

Cuando cargamos la herramienta por primera vez, se nos solicitan las credenciales de inicio de sesión o que carguemos una instantánea anterior. Podemos iniciar sesión con cualquier usuario de dominio válido.

#### Iniciar sesión con AD Explorer

![imagen](https://academy.hackthebox.com/storage/modules/47/AD_explorer1.png)

Una vez que hayamos iniciado sesión, podremos navegar libremente por AD y ver información sobre todos los objetos.
#### Navegando por AD con AD Explorer
![imagen](https://academy.hackthebox.com/storage/modules/47/AD_explorer_logged_in.png)

Para tomar una instantánea de AD, vaya a Archivo --> `Create Snapshot`e ingrese un nombre para la instantánea. Una vez que esté completo, podemos desconectarlo para realizar un análisis más detallado.
#### Crear una instantánea de AD con AD Explorer
![imagen](https://academy.hackthebox.com/storage/modules/47/AD_explorer_snapshot.png)

### Ping Castle
[PingCastle](https://www.pingcastle.com/documentation/) es una poderosa herramienta que evalúa la postura de seguridad de un entorno AD y nos proporciona los resultados en varios mapas y gráficos diferentes. Pensando en la seguridad por un segundo, si no tiene un inventario activo de los hosts en su empresa, PingCastle puede ser un gran recurso para ayudarlo a reunir uno en un mapa del dominio agradable y legible por el usuario. PingCastle se diferencia de herramientas como PowerView y BloodHound porque, además de proporcionarnos datos de enumeración que pueden informar nuestros ataques, también proporciona un informe detallado del nivel de seguridad del dominio objetivo utilizando una metodología basada en un marco de evaluación/madurez de riesgos. La puntuación que se muestra en el informe se basa en la [integración del modelo de madurez de capacidad](https://en.wikipedia.org/wiki/Capability_Maturity_Model_Integration) (CMMI). Para echar un vistazo rápido al contexto de ayuda proporcionado, puede activar el `--help`modificador en cmd-prompt.

Nota: Si tiene problemas para iniciar la herramienta, cambie la fecha del sistema a una fecha anterior al 31 de julio de 2023 mediante el Panel de control (establezca la hora y la fecha).
#### Visualización del menú de ayuda de PingCastle

```cmd-session
C:\htb> PingCastle.exe --help

switch:
  --help              : display this message
  --interactive       : force the interactive mode
  --log               : generate a log file
  --log-console       : add log to the console
  --log-samba <option>: enable samba login (example: 10)

Common options when connecting to the AD
  --server <server>   : use this server (default: current domain controller)
                        the special value * or *.forest do the healthcheck for all domains
  --port <port>       : the port to use for ADWS or LDAP (default: 9389 or 389)
  --user <user>       : use this user (default: integrated authentication)
  --password <pass>   : use this password (default: asked on a secure prompt)
  --protocol <proto>  : selection the protocol to use among LDAP or ADWS (fastest)
                      : ADWSThenLDAP (default), ADWSOnly, LDAPOnly, LDAPThenADWS

<SNIP>  
```
#### Ejecutando PingCastillo
Para ejecutar PingCastle, podemos llamar al ejecutable escribiendo `PingCastle.exe`en nuestra ventana CMD o PowerShell o haciendo clic en el ejecutable, y nos llevará al modo interactivo, presentándonos un menú de opciones dentro de `Terminal User Interface`( `TUI`).
#### TUI interactiva PingCastle
```cmd-session
|:.      PingCastle (Version 2.10.1.0     1/19/2022 8:12:02 AM)
|  #:.   Get Active Directory Security at 80% in 20% of the time
# @@  >  End of support: 7/31/2023
| @@@:
: .#                                 Vincent LE TOUX (contact@pingcastle.com)
  .:       twitter: @mysmartlogon                    https://www.pingcastle.com
What do you want to do?
=======================
Using interactive mode.
Do not forget that there are other command line switches like --help that you can use
  1-healthcheck-Score the risk of a domain
  2-conso      -Aggregate multiple reports into a single one
  3-carto      -Build a map of all interconnected domains
  4-scanner    -Perform specific security checks on workstations
  5-export     -Export users or computers
  6-advanced   -Open the advanced menu
  0-Exit
==============================
This is the main functionnality of PingCastle. In a matter of minutes, it produces a report which will give you an overview of your Active Directory security. This report can be generated on other domains by using the existing trust links.
```

La opción predeterminada es `healthcheck`ejecutar, que establecerá una descripción general básica del dominio y nos proporcionará información pertinente sobre configuraciones erróneas y vulnerabilidades. Aún mejor, PingCastle puede informar la susceptibilidad a vulnerabilidades recientes, nuestras acciones, fideicomisos, la delegación de permisos y mucho más sobre los estados de nuestros usuarios y computadoras. En la opción Escáner podemos encontrar la mayoría de estos controles.
#### Opciones de escáner

```cmd-session
|:.      PingCastle (Version 2.10.1.0     1/19/2022 8:12:02 AM)
|  #:.   Get Active Directory Security at 80% in 20% of the time
# @@  >  End of support: 7/31/2023
| @@@:
: .#                                 Vincent LE TOUX (contact@pingcastle.com)
  .:       twitter: @mysmartlogon                    https://www.pingcastle.com
Select a scanner
================
What scanner whould you like to run ?
WARNING: Checking a lot of workstations may raise security alerts.
  1-aclcheck                                                  9-oxidbindings
  2-antivirus                                                 a-remote
  3-computerversion                                           b-share
  4-foreignusers                                              c-smb
  5-laps_bitlocker                                            d-smb3querynetwork
  6-localadmin                                                e-spooler
  7-nullsession                                               f-startup
  8-nullsession-trust                                         g-zerologon
  0-Exit
==============================
Check authorization related to users or groups. Default to everyone, authenticated users and domain users
```
#### Ver el informe
A lo largo del informe, hay secciones como información de dominio, usuario, grupo y confianza y una tabla específica que indica "anomalías" o problemas que pueden requerir atención inmediata. También se nos presentará la puntuación de riesgo general del dominio.

![texto](https://academy.hackthebox.com/storage/modules/143/report-example.png)

Además de ser útil para realizar una enumeración de dominios muy exhaustiva cuando se combina con otras herramientas, PingCastle puede ser útil para brindar a los clientes un análisis rápido de la postura de seguridad de su dominio, o puede ser utilizado por equipos internos para autoevaluarse y encontrar áreas de preocupación u oportunidades. para un mayor endurecimiento. Tómese un tiempo para explorar los informes y mapas que PingCastle puede generar en el dominio de Inlanefreight.
#### Política de grupo
Dado que la política de grupo es una gran parte de cómo se realiza la administración de computadoras y usuarios de AD, es lógico que queramos auditar su configuración y resaltar cualquier agujero potencial. `Group3r`es una excelente herramienta para esto.

---
## grupo3r

[Group3r](https://github.com/Group3r/Group3r) es una herramienta diseñada específicamente para encontrar vulnerabilidades en la política de grupo asociada a Active Directory. Group3r debe ejecutarse desde un host unido a un dominio con un usuario de dominio (no necesita ser administrador) o en el contexto de un usuario de dominio (es decir, usando `runas /netonly`).

#### Uso básico de Group3r

```cmd-session
C:\htb> group3r.exe -f <filepath-name.log> 
```

Al ejecutar Group3r, debemos especificar `-s`o la `-f`bandera. Estos especificarán si enviar los resultados a la salida estándar (-s) o al archivo al que queremos enviar los resultados (-f). Para obtener más opciones e información de uso, utilice la `-h`bandera o consulte la información de uso en el enlace de arriba.

A continuación se muestra un ejemplo de cómo iniciar Group3r.
#### Salida de lectura

![texto](https://academy.hackthebox.com/storage/modules/143/grouper-output.png)

Al leer el resultado de Group3r, cada sangría es un nivel diferente, por lo que ninguna sangría será el GPO, una sangría será la configuración de políticas y otra serán los hallazgos en esas configuraciones. A continuación, echaremos un vistazo al resultado que se muestra de un hallazgo.

#### Hallazgo Group3r

![texto](https://academy.hackthebox.com/storage/modules/143/grouper-finding.png)

En la imagen de arriba, verá un ejemplo de un hallazgo de Group3r. Lo presentará como un cuadro vinculado a la configuración de políticas, definirá la parte interesante y nos dará una razón para el hallazgo. Vale la pena el esfuerzo de ejecutar Group3r si tienes la oportunidad. A menudo encontrará caminos u objetos interesantes que otras herramientas pasarán por alto.

---

## ADRecon

Finalmente, existen otras herramientas que son útiles para recopilar una gran cantidad de datos de AD a la vez. En una evaluación donde no se requiere sigilo, también vale la pena ejecutar una herramienta como [ADRecon](https://github.com/adrecon/ADRecon) y analizar los resultados, en caso de que en toda nuestra enumeración se haya perdido algo menor que pueda ser útil para nosotros o que valga la pena señalarle a nuestro cliente.

#### Ejecutando ADRecon

```powershell-session
PS C:\htb> .\ADRecon.ps1

[*] ADRecon v1.1 by Prashant Mahajan (@prashant3535)
[*] Running on INLANEFREIGHT.LOCAL\MS01 - Member Server
[*] Commencing - 03/28/2022 09:24:58
[-] Domain
[-] Forest
[-] Trusts
[-] Sites
[-] Subnets
[-] SchemaHistory - May take some time
[-] Default Password Policy
[-] Fine Grained Password Policy - May need a Privileged Account
[-] Domain Controllers
[-] Users and SPNs - May take some time
[-] PasswordAttributes - Experimental
[-] Groups and Membership Changes - May take some time
[-] Group Memberships - May take some time
[-] OrganizationalUnits (OUs)
[-] GPOs
[-] gPLinks - Scope of Management (SOM)
[-] DNS Zones and Records
[-] Printers
[-] Computers and SPNs - May take some time
[-] LAPS - Needs Privileged Account
[-] BitLocker Recovery Keys - Needs Privileged Account
[-] GPOReport - May take some time
[*] Total Execution Time (mins): 11.05
[*] Output Directory: C:\Tools\ADRecon-Report-20220328092458
```

Una vez hecho esto, ADRecon nos arrojará un informe en una nueva carpeta en el directorio desde el que ejecutamos. Podemos ver un ejemplo de los resultados en la terminal a continuación. Obtendrá un informe en formato HTML y una carpeta con los resultados CSV. Al generar el informe, se debe tener en cuenta que es necesario instalar el programa Excel, o el script no generará automáticamente el informe de esa manera; simplemente te dejará con los archivos .csv. Si desea obtener resultados para la Política de grupo, debe asegurarse de que el host desde el que ejecuta tenga `GroupPolicy`instalado el módulo PowerShell. Podemos regresar más tarde y generar el informe de Excel desde otro host usando el `-GenExcel`interruptor y alimentándolo en la carpeta de informes.

#### Informes

```powershell-session
PS C:\htb> ls

    Directory: C:\Tools\ADRecon-Report-20220328092458

Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----         3/28/2022  12:42 PM                CSV-Files
-a----         3/28/2022  12:42 PM        2758736 GPO-Report.html
-a----         3/28/2022  12:42 PM         392780 GPO-Report.xml
```

---

Hemos cubierto muchas herramientas y tácticas en este módulo, pero consideramos prudente mostrar y explicar algunas otras formas de auditar un dominio objetivo. Tenga en cuenta que sus acciones deben tener un propósito y nuestro objetivo final es mejorar la postura de seguridad del cliente. Teniendo esto en cuenta, adquirir más pruebas de los problemas sólo servirá para:

`Make our reporting more convincing and provide the customer with the tools they need to fix & actively secure their domain`.